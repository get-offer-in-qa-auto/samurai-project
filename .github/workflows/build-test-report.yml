name: Build, UI & API Tests, Report

on: [push, workflow_dispatch]

jobs:
  linter:
    name: Linter (Checkstyle)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Run Checkstyle
        run: mvn checkstyle:check -Dcheckstyle.failOnViolation=true

  run-tests:
    name: Build and run tests
    runs-on: ubuntu-latest
    needs: linter

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK and Maven
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: maven

      - name: Make Maven Wrapper executable
        run: chmod +x ./mvnw

      - name: Compile project (download dependencies and Lombok)
        run: ./mvnw clean compile -DskipTests -Pcompile-lombok
        continue-on-error: true

      - name: Set up services
        run: cd infra/docker_compose && bash restart_docker.sh && cd ../..

      # ==================== –û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–Ω—è—Ç–∏—è TeamCity –∏ Selenoid =====================
      - name: Wait for TeamCity /mnt endpoint to be ready
        run: |
          echo "Waiting for TeamCity to be ready..."
          for i in {1..60}; do
            # –ü—Ä–æ–±—É–µ–º –∏–º–µ–Ω–Ω–æ —Ç–æ—Ç endpoint, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–µ—Å—Ç
            if curl -s -f "http://localhost:8111/mnt" > /dev/null 2>&1; then
              echo "TeamCity /mnt endpoint is ready!"
              break
            fi
            echo "Attempt $i/60 - TeamCity not ready yet..."
            sleep 10
          done
          
          # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
          echo "Final check:"
          curl -v http://localhost:8111/mnt || echo "WARNING: /mnt still not accessible"

      - name: Wait for Selenoid to be ready
        run: |
          echo "Waiting for Selenoid to be ready..."
          for i in {1..30}; do
            status=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:4444/wd/hub/status)
            if [[ "$status" == "200" ]]; then
              echo "Selenoid is ready"
              break
            else
              echo "Selenoid not ready yet, status=$status"
            fi
            sleep 5
          done

      # ===================== –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤  =======================
      - name: Run superuser tests on runner
        env:
          SERVERUI: http://teamcity-server:8111
          UIREMOTE: http://localhost:4444/wd/hub
        run: |
          echo "=== CHECK SERVICES BEFORE TESTS ==="
          echo "TeamCity:"
          if ! curl -s -f http://localhost:8111/mnt > /dev/null 2>&1; then
            echo "‚ùå TeamCity not reachable!"
            exit 1
          else
            echo "‚úÖ TeamCity is reachable"
          fi

          echo "Selenoid:"
          if ! curl -s -f http://localhost:4444/wd/hub/status > /dev/null 2>&1; then
            echo "‚ùå Selenoid not reachable!"
            exit 1
          else
            echo "‚úÖ Selenoid is reachable"
          fi

          echo
          echo "=== TEST CONFIG ==="
          echo "SERVER = $SERVER"
          echo "UIREMOTE = $UIREMOTE"
          echo

          echo "=== RUNNING TESTS ==="
          ./mvnw test -P run-superuser-test -q

      - name: Run API tests
        run: ./mvnw test -P api
        continue-on-error: true

      - name: Run UI tests
        env:
          SERVERUI: http://teamcity-server:8111
          UIREMOTE: http://localhost:4444/wd/hub
        run: |
          echo "=== CHECK SERVICES BEFORE TESTS ==="
          echo "TeamCity:"
          if ! curl -s -f http://localhost:8111/mnt > /dev/null 2>&1; then
            echo "‚ùå TeamCity not reachable!"
            exit 1
          else
            echo "‚úÖ TeamCity is reachable"
          fi

          echo "Selenoid:"
          if ! curl -s -f http://localhost:4444/wd/hub/status > /dev/null 2>&1; then
            echo "‚ùå Selenoid not reachable!"
            exit 1
          else
            echo "‚úÖ Selenoid is reachable"
          fi

          echo
          echo "=== TEST CONFIG ==="
          echo "SERVER = $SERVER"
          echo "UIREMOTE = $UIREMOTE"
          echo

          echo "=== RUNNING TESTS ==="
          ./mvnw test -P ui -q
        continue-on-error: true

      # =============== –û—Ç—á–µ—Ç—ã: Allure report, Swagger coverage  ===============
      - name: Run Swagger coverage
        if: always()
        run: |
          curl -s http://localhost:8111/app/rest/swagger.json -o teamcity-swagger.json
          chmod +x .swagger-coverage-commandline/bin/swagger-coverage-commandline
          
          .swagger-coverage-commandline/bin/swagger-coverage-commandline \
            -s teamcity-swagger.json \
            -i target/swagger-coverage-output

      - name: Load test report history           # –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –æ—Ç—á—ë—Ç–æ–≤ Allure
        uses: actions/checkout@v2
        if: always()
        with:
          ref: gh-pages
          path: gh-pages

      - name: Build test report                  # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º Allure-–æ—Ç—á—ë—Ç, —Å–∫–ª–∞–¥—ã–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –∏ –Ω–æ–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        uses: simple-elf/allure-report-action@v1.13
        if: always()
        with:
          gh_pages: gh-pages
          allure_results: target/allure-results
          allure_history: allure-history

      - name: Build swagger coverage report      # –ö–æ–ø–∏—Ä—É–µ–º html-–æ—Ç—á—ë—Ç –ø–æ Swagger coverage –≤ –∫–∞—Ç–∞–ª–æ–≥ allure-history
        if: always()
        run: sudo cp swagger-coverage-report.html allure-history/${{ github.run_number }}


      - name: Publish test report                # –ü—É–±–ª–∏–∫—É–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é allure-history –≤ –≤–µ—Ç–∫—É gh-pages
        uses: peaceiris/actions-gh-pages@v3
        if: always()
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: allure-history

      # =============== –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã: –ª–æ–≥–∏ –∏ –æ—Ç—á—ë—Ç—ã  ===============
      - name: Upload test logs (Surefire / Failsafe)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs
          path: |
            target/surefire-reports
            target/failsafe-reports
          retention-days: 7

      - name: Generate and upload Allure HTML report
        if: always()
        run: |
          mkdir -p target/allure-report
          curl -sL https://github.com/allure-framework/allure2/releases/download/2.25.0/allure-2.25.0.tgz -o allure.tgz
          tar -xzf allure.tgz
          ./allure-2.25.0/bin/allure generate target/allure-results --clean -o target/allure-report
        continue-on-error: true

      - name: Collect Docker container logs
        if: always()
        run: |
          mkdir -p docker-logs
          echo "=== Available containers ==="
          docker ps -a --format "table {{.Names}}\t{{.Status}}\t{{.Image}}"
          echo
          # –õ–æ–≥–∏ TeamCity
          docker logs --timestamps teamcity-server > docker-logs/teamcity.log 2>&1 || echo "teamcity-server not found" > docker-logs/teamcity.log
          # –õ–æ–≥–∏ Selenoid 
          docker logs --timestamps selenoid > docker-logs/selenoid.log 2>&1 || echo "selenoid not found" > docker-logs/selenoid.log

      - name: Upload Docker logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: docker-logs
          path: docker-logs
          retention-days: 7

      # ===============  –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram ===============
      - name: Notify Telegram
        if: always()
        run: |
          echo "Waiting 60 seconds before sending notification..."
          sleep 60
          
          # –°—Ç–∞—Ç—É—Å —Ç–µ—Å—Ç–æ–≤
          STATUS="‚ùå FAILED"
          EMOJI="‚ùå"
          if [[ "${{ job.status }}" == "success" ]]; then
            STATUS="‚úÖ PASSED"
            EMOJI="‚úÖ"
          fi
          
          # –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ –æ—Ç—á–µ—Ç—ã
          REPORT_BASE="https://get-offer-in-qa-auto.github.io/samurai-project/${{ github.run_number }}"
          ALLURE_REPORT="${REPORT_BASE}/index.html"
          SWAGGER_REPORT="${REPORT_BASE}/swagger-coverage-report.html"
          
          # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="HTML" \
            -d text="$EMOJI Tests $STATUS #${{ github.run_number }}

          üì¶ Repo <a href='${{ github.server_url }}/${{ github.repository }}'>TeamCityProject</a>
          üåø Branch <a href='${{ github.server_url }}/${{ github.repository }}/tree/${{ github.ref_name }}'>${{ github.ref_name }}</a>
          üë§ Actor ${{ github.actor }}
          
          üîó Action run <a href='${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'>View Run</a>
          üìä Allure <a href='${ALLURE_REPORT}'>Report</a>"
#          üìà <a href='${SWAGGER_REPORT}'>API Coverage</a>"

      - name: Clean up services
        if: always()
        run: cd infra/docker_compose && docker compose down